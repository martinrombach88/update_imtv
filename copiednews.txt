

const setFilePath = (folder, filename) => {
  return path.join("assets", "images", folder, filename);
};
const newsList = getListFromFile("news.json");
const getListFromFile = (jsonFile) => {
  const jsonPath = path.join(
    path.dirname(process.mainModule.filename),
    "data",
    jsonFile
  );
  const file = fs.readFileSync(jsonPath);
  return JSON.parse(file);
};

router.get("/news", (req, res) => {
  const newsList = getListFromFile({ newsJSON });
  res.render("news", {
    path: "/news",
    pageTitle: "Update News",
    object: newsList,
  });
});

router.get("/newsForm", (req, res) => {
  res.render("newsForm", {
    path: "/newsForm",
    pageTitle: "Update News",
    object: newsList,
  });
});

router.post("/newsForm", (req, res) => {
  let today = new Date();
  let dd = String(today.getDate()).padStart(2, "0");
  let mm = String(today.getMonth() + 1).padStart(2, "0");
  let yyyy = today.getFullYear();
  let dateENG = dd + "/" + mm + "/" + +yyyy;
  let dateKR = yyyy + " " + mm + "ì›” " + dd;
  let newsObject = {};
  let newsBodyKR = [];
  let newsBodyENG = [];
  newsObject.id = newsList[0].id + 1;
  newsObject.titleKR = req.body.titleKR;
  newsObject.titleENG = req.body.titleENG;
  newsObject.dateKR = dateKR;
  newsObject.dateENG = dateENG;
  for (let i = 1; i <= 14; i++) {
    i <= 7 ? newsBodyKR.push(req.body[i]) : newsBodyENG.push(req.body[i]);
  }
  newsObject.bodyKR = newsBodyKR;
  newsObject.bodyENG = newsBodyENG;
  newsObject.image = setFilePath("news", req.body.image);
  newsObject.imageLarge = setFilePath("news", req.body.imageLarge);
  writeToList("news.json", newsObject);
  res.redirect("/news");
});

router.post("/deleteNewsForm", (req, res) => {
  let id = req.body.id;
  let newsObject = newsJSON;
  let target = newsObject.length - id;
  for (let i = 0; i <= newsObject.length; i++) {
    if (i === target) {
      newsObject.splice(i, 1);
    }
  }
  overwriteFile("news.json", newsObject);
  res.redirect("/deleted");
});

router.post("/editNewsLink", (req, res) => {
  let newsObject = newsJSON;
  let id = req.body.id;
  let target = newsObject.length - id;
  for (let i = 0; i <= newsObject.length; i++) {
    if (i === target) {
      currentNews = newsObject[i];
    }
  }
  res.redirect("/editNewsForm");
});

router.get("/editNewsForm", (req, res) => {
  res.render("editNewsForm", {
    path: "/editNewsForm",
    pageTitle: "Edit News",
    object: currentNews,
  });
});

router.post("/editNewsForm", (req, res) => {
  let newsObject = newsJSON;
  let newsBodyKR = [];
  let newsBodyENG = [];
  let id = req.body.id;
  let target = newsObject.length - id;
  newsObject[target].id = id;
  newsObject[target].titleKR = req.body.titleKR;
  newsObject[target].titleENG = req.body.titleENG;
  for (let i = 1; i <= 14; i++) {
    i <= 7 ? newsBodyKR.push(req.body[i]) : newsBodyENG.push(req.body[i]);
  }
  newsObject[target].bodyKR = newsBodyKR;
  newsObject[target].bodyENG = newsBodyENG;
  newsObject[target].image = setFilePath("news", req.body.image);
  newsObject[target].imageLarge = setFilePath("news", req.body.imageLarge);
  overwriteFile("news.json", newsObject);
  res.redirect("/changeEdit");
});